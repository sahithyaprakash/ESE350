#include <unistd.h>
#include <avr/io.h>
#include "../Arduino_ATMega/uart.h"
#include "../ST7565-LCD/c/glcd.h"
#include "../ST7565-LCD/c/stlcd.h"


#define PWR_SEL_REG PORTD
#define PWR_SEL_0 PORTD2
#define PWR_SEL_1 PORTD3
#define PWR_SEL_2 PORTD4

#define MUX_SEL_LVL1_REG PORTC
#define MUX_SEL_LVL1_BIT0 PORTC0
#define MUX_SEL_LVL1_BIT1 PORTC1
#define MUX_SEL_LVL1_BIT2 PORTC2
#define MUX_SEL_LVL1_BIT3 PORTC3

#define MUX_SEL_LVL2_REG PORTB
#define MUX_SEL_LVL2_BIT0 PORTB2
#define MUX_SEL_LVL2_BIT1 PORTB3
#define MUX_SEL_LVL2_BIT2 PORTB4
#define MUX_SEL_LVL2_BIT3 PORTB5

#define INPUT_PIN PINC4
#define INPUT_PIN_REG DDRC

uint8_t st7565_buffer[1024] = { 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 

0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x0, 0x3, 0x7, 0xF, 0x1F, 0x1F, 0x3F, 0x3F, 0x3F, 0x3F, 0x7, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x7F, 0x3F, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x1F, 0x3F, 0x70, 0x70, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x6, 0x6, 0x0, 0x0, 0x0, 0x3, 0x3, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 

0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0x1F, 0xF, 0x7, 0x7, 
0x7, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x3E, 0x0, 0x0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xF, 0x3F, 
0x70, 0x60, 0x60, 0x60, 0x60, 0x30, 0x7F, 0x3F, 0x0, 0x0, 0x1F, 0x3F, 0x70, 0x60, 0x60, 0x60, 
0x60, 0x39, 0xFF, 0xFF, 0x0, 0x6, 0x1F, 0x39, 0x60, 0x60, 0x60, 0x60, 0x30, 0x3F, 0x7F, 0x0, 
0x0, 0x60, 0xFF, 0xFF, 0x60, 0x60, 0x0, 0x7F, 0x7F, 0x70, 0x60, 0x60, 0x40, 0x0, 0x7F, 0x7F, 
0x0, 0x0, 0x0, 0x0, 0x7F, 0x7F, 0x0, 0x0, 0x0, 0x7F, 0x7F, 0x0, 0x0, 0x60, 0xFF, 0xFF, 
0x60, 0x60, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 

0x80, 0xF8, 0xFC, 0xFE, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xEF, 0xE7, 0xE7, 0xE3, 
0xF3, 0xF9, 0xFF, 0xFF, 0xFF, 0xF7, 0x7, 0x1F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x7F, 0xFF, 
0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x7F, 0x3F, 0x3F, 0x1F, 0xF, 0x7, 0x3, 0x0, 0x0, 0x0, 0xC0, 
0xE0, 0x60, 0x20, 0x20, 0x60, 0xE0, 0xE0, 0xE0, 0x0, 0x0, 0x80, 0xC0, 0xE0, 0x60, 0x20, 0x60, 
0x60, 0xE0, 0xE0, 0xE0, 0x0, 0x0, 0x80, 0xC0, 0x60, 0x60, 0x20, 0x60, 0x60, 0xE0, 0xE0, 0x0, 
0x0, 0x0, 0xE0, 0xE0, 0x0, 0x0, 0x0, 0xE0, 0xE0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x80, 0xE0, 
0x60, 0x60, 0x60, 0x60, 0xE0, 0x80, 0x0, 0x0, 0x0, 0xE0, 0xE0, 0x0, 0x0, 0x0, 0xE0, 0xE0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 

0x0, 0x0, 0x0, 0x3, 0x7, 0x1F, 0x9F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFD, 0xF1, 0xE3, 
0xE3, 0xCF, 0xFF, 0xFF, 0xFF, 0xFF, 0xF0, 0xFC, 0x7F, 0x3F, 0x3F, 0x3F, 0x3F, 0x7F, 0xFF, 0xFF, 
0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFC, 0xF0, 0xE0, 0x80, 0x0, 0x0, 0x0, 0xC, 
0x1C, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7F, 0x7F, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x7, 0x7, 0x0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x1C, 0xC, 0x0, 0x0, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 

0x0, 0x7, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFE, 0xFE, 0xFE, 0xFE, 0xFC, 0xF8, 
0xF8, 0xF0, 0xFE, 0xFF, 0xFF, 0xFF, 0x7F, 0x3F, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0x1F, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xFF, 
0xFF, 0x0, 0x0, 0x0, 0xFF, 0xFF, 0xE0, 0xC0, 0xC0, 0xC0, 0xFF, 0x7F, 0x0, 0x0, 0x1E, 0x7F, 
0xE1, 0xC0, 0xC0, 0xC0, 0xC0, 0x61, 0xFF, 0xFF, 0x0, 0x0, 0xFE, 0xFF, 0x1, 0x0, 0x0, 0x0, 
0xFF, 0xFF, 0x0, 0x0, 0x21, 0xF9, 0xF8, 0xDC, 0xCC, 0xCF, 0x7, 0x0, 0xC0, 0xFF, 0xFF, 0xC0, 
0x80, 0x0, 0xFF, 0xFF, 0xC0, 0xC0, 0x80, 0x0, 0x0, 0xFF, 0xFF, 0x0, 0x0, 0x1F, 0x7F, 0xF9, 
0xC8, 0xC8, 0xC8, 0xC8, 0x79, 0x39, 0x0, 0x0, 0x71, 0xF9, 0xD8, 0xCC, 0xCE, 0x47, 0x3, 0x0, 

0x0, 0x0, 0x0, 0x0, 0x80, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 
0x0, 0x0, 0x0, 0x80, 0xC0, 0xE0, 0xF0, 0xF8, 0xF8, 0xFC, 0xFC, 0xFC, 0xFC, 0xF8, 0xF0, 0xC0, 
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xC0, 
0xC0, 0x0, 0x0, 0x0, 0xC0, 0xC0, 0x0, 0x0, 0x0, 0x0, 0xC0, 0xC0, 0x0, 0x0, 0x0, 0x80, 
0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x80, 0xC0, 0xC0, 0x0, 0x0, 0x0, 0x80, 0xC0, 0xC0, 0xC0, 0xC0, 
0xC0, 0x80, 0x0, 0x0, 0x80, 0xC0, 0xC0, 0xC0, 0xC0, 0xC0, 0x0, 0x0, 0x0, 0xC0, 0xC0, 0x0, 
0x0, 0x0, 0xC0, 0x80, 0x0, 0x0, 0x0, 0x0, 0x0, 0xC0, 0xC0, 0x0, 0x0, 0x0, 0x80, 0xC0, 
0xC0, 0xC0, 0xC0, 0xC0, 0x80, 0x80, 0x0, 0x0, 0x80, 0xC0, 0xC0, 0xC0, 0xC0, 0x80, 0x0, 0x0, 

0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,};

// Calculates the amount of liquid in a single column (mL)
// from the height of the liquid in number of coducting datapoints
float liquidAmount(int heighestConductor) {
	if (heighestConductor > 0) {
		float actuationDepth = 2.5;
		float unitVolume = 3.175;
		printf("actuation: %f \n", actuationDepth);
		printf("unitVolume: %f \n", unitVolume);
		printf("first: %d \n", (heighestConductor - 1) * unitVolume);
		printf("second: %u \n", actuationDepth + (heighestConductor - 1) * unitVolume);

		return actuationDepth + (heighestConductor - 1) * unitVolume;
	} else {
		return 0;
	}
}

double getConductivity() {
	//start ADC read
	ADCSRA |= (1 << ADSC);
	while((ADCSRA & (1 << ADIF)) != (1 << ADIF));
	double analogValue = ((double) 1 / (double) 0xFF) * ADC;
	return analogValue;
}

// sets the given registers given bit number to the given value
unsigned int setOnlyBitInRegisterToValue(unsigned int reg, unsigned int bit, unsigned int value) {
	//get a bit value with all 1s except for a zero in the designated bit's place.
	unsigned int clearedBit =  reg & 0xFF << (bit + 1) | 0xFF >> (8 - bit);
	//return the original register cleared and then set to the value given by the value
	return ((reg & clearedBit) | ((value & 0x01) << bit));
}

// Switches the high potential to the column designated by the variable columnNumber (zero index, right to left)
void switchPowerToColumnNumber(int columnNumber) {
	//save the current register value
	unsigned int PWR_SEL_REG_NEW = PWR_SEL_REG;

	//update the value to the new register value
	PWR_SEL_REG_NEW = setOnlyBitInRegisterToValue(PWR_SEL_REG_NEW, PWR_SEL_0, (columnNumber & 0x01));
	PWR_SEL_REG_NEW = setOnlyBitInRegisterToValue(PWR_SEL_REG_NEW, PWR_SEL_1, ((columnNumber & 0x02) >> 1));
	PWR_SEL_REG_NEW = setOnlyBitInRegisterToValue(PWR_SEL_REG_NEW, PWR_SEL_2, ((columnNumber & 0x04) >> 2));

	//set the register value (only happens once)
	PWR_SEL_REG = PWR_SEL_REG_NEW;
}

// Switches to reading the value at the given height
void switchMuxesToHeight(int height) {
	//save the current 1st level register value
	unsigned int MUX_SEL_LVL1_REG_NEW = MUX_SEL_LVL1_REG;

	//set the new values to the given values (height)
	MUX_SEL_LVL1_REG_NEW = setOnlyBitInRegisterToValue(MUX_SEL_LVL1_REG_NEW, MUX_SEL_LVL1_BIT0, (height & 0x01));
	MUX_SEL_LVL1_REG_NEW = setOnlyBitInRegisterToValue(MUX_SEL_LVL1_REG_NEW, MUX_SEL_LVL1_BIT1, ((height & 0x02) >> 1));
	MUX_SEL_LVL1_REG_NEW = setOnlyBitInRegisterToValue(MUX_SEL_LVL1_REG_NEW, MUX_SEL_LVL1_BIT2, ((height & 0x04) >> 2));
	MUX_SEL_LVL1_REG_NEW = setOnlyBitInRegisterToValue(MUX_SEL_LVL1_REG_NEW, MUX_SEL_LVL1_BIT3, ((height & 0x08) >> 3));

	//set the register (only happens once)
	MUX_SEL_LVL1_REG = MUX_SEL_LVL1_REG_NEW;

	//save the 2n level register value
	unsigned int MUX_SEL_LVL2_REG_NEW = MUX_SEL_LVL2_REG;

	//set the new values to the given ones (height)
	MUX_SEL_LVL2_REG_NEW = setOnlyBitInRegisterToValue(MUX_SEL_LVL2_REG_NEW, MUX_SEL_LVL2_BIT0, ((height & 0x10) >> 4));
	MUX_SEL_LVL2_REG_NEW = setOnlyBitInRegisterToValue(MUX_SEL_LVL2_REG_NEW, MUX_SEL_LVL2_BIT1, ((height & 0x20) >> 5));
	MUX_SEL_LVL2_REG_NEW = setOnlyBitInRegisterToValue(MUX_SEL_LVL2_REG_NEW, MUX_SEL_LVL2_BIT2, ((height & 0x40) >> 6));
	MUX_SEL_LVL2_REG_NEW = setOnlyBitInRegisterToValue(MUX_SEL_LVL2_REG_NEW, MUX_SEL_LVL2_BIT3, ((height & 0x80) >> 7));

	//set the register (only happens once)
	MUX_SEL_LVL2_REG = MUX_SEL_LVL2_REG_NEW;
}

//set up the ADC for reading the exact voltage
void setupADC() {
	ADMUX = 0x40; 		// choosing reference voltage
	ADMUX |= 0x05; 		// set which channel we want to read from (PIN A5)
	ADCSRA = 0xE0; 		// enables the adc and starts the conversions and enables auto trigger
	ADCSRA |= 0x07; 	// sets the clock prescalser to 128
	ADCSRB = 0x00; 		// free running mode (always taking sample) 
}

int main (void) {
	// initialize controller state
	uint8_t x = 10;
	uint8_t y = 10;
	uint8_t color = 0;

	uart_inits();
	setupADC();
	TCCR0A = 0x05; 					// start timer, prescaler = 1024

	// set registers to outputs
	DDRB = 0xFF;
	DDRC = 0xEF; //all outputs except for pin 4
	DDRD = 0xFF;

	st7565_init();
	while (1) {
		//write_buffer(st7565_buffer);
		st7565_data(5);
	}

	while (1) {
		unsigned int highest_conductor = 0x00;
		unsigned int current;
		float conductingVoltage = 0x00;
		float liquidAmt = 0x00;


		for (unsigned int column = 0x00; column < 7; column ++) {


			switchPowerToColumnNumber(column);
			for (current = 0x00; current < 0xA9; current ++) {
				if (current == 0x00) {
					conductingVoltage = getConductivity();
				}
				switchMuxesToHeight(current);

				//wait for a little bit
				for(unsigned int a = 0x00; a < 0xFF; a ++);

				if (((INPUT_PIN_REG >> (INPUT_PIN - 1)) & 0x01) == 0x01) {
					highest_conductor = current + 1;
				}
			}
			liquidAmt = liquidAmount(highest_conductor);
			printf("Highest Conductor: (%i, %i) ", highest_conductor, column);
			printf(" | %u mL ", liquidAmt);
			printf(" | %u V \n", conductingVoltage);

			highest_conductor = 0x00;
		}
		
	}
}